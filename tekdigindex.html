<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PET+CLINIC - Sistem Rekam Medis Veteriner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        /* --- CSS Kustom untuk Tampilan --- */
        body { background-color: #f4f6f9; }
        .login-page {
            display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f8f9fa;
        }
        .login-container {
            max-width: 900px; width: 100%; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,.1); overflow: hidden; background-color: white;
        }
        .image-side {
            background-color: #e9ecef; display: flex; justify-content: center; align-items: center;
        }
        .login-form-side { padding: 40px; }
        .clinic-logo { width: 80px; height: 80px; margin-bottom: 20px; }

        /* Dashboard Layout Styling */
        .sidebar {
            width: 250px; background-color: #4c4d9e; position: fixed; height: 100%; padding: 0; color: white; transition: all 0.3s;
            z-index: 1050; /* Pastikan sidebar di atas konten lain saat terbuka */
        }
        .sidebar .nav-link {
            color: white; padding: 15px 20px; font-size: 1.05rem; border-left: 5px solid transparent;
        }
        .sidebar .nav-link.active,
        .sidebar .nav-link:hover {
            background-color: #6a6baf; border-left: 5px solid #ffffff;
        }
        .sidebar-header {
            padding: 20px; font-size: 1.5rem; font-weight: bold; text-align: center; background-color: #3e3f80;
        }
        .main-content {
            margin-left: 250px; padding: 20px;
        }
        .topbar {
            background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,.05); padding: 15px 20px; margin-bottom: 20px; display: flex; justify-content: flex-end; align-items: center;
        }
        .card-info {
            border-left: 4px solid #4c4d9e;
        }
        .page-content {
            background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,.05);
        }
        .btn-primary-custom {
            background-color: #4c4d9e; border-color: #4c4d9e; color: white;
        }
        .btn-primary-custom:hover {
            background-color: #3e3f80; border-color: #3e3f80; color: white;
        }

        /* PERBAIKAN: Responsif - Tampilan Mobile */
        @media (max-width: 992px) { /* Layar tablet/mobile */
            .sidebar {
                margin-left: -250px; /* Sembunyikan sidebar di luar layar */
                position: fixed;
            }
            .sidebar.active {
                margin-left: 0; /* Tampilkan sidebar saat aktif */
            }
            .main-content {
                margin-left: 0 !important; /* Main content ambil seluruh lebar */
                width: 100%;
            }
        }
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1040;
            display: none;
        }
    </style>
</head>
<body>

<div id="loginPage" class="login-page">
    <div class="login-container row g-0">
        <div class="image-side col-md-6 d-none d-md-flex">
            <p class="text-center p-4 text-muted">Ilustrasi Pekerja Klinik</p>
        </div>
        <div class="login-form-side col-md-6">
            <div class="text-center">
                
                <h4 class="mb-1">Login</h4>
                <p class="text-muted">Welcome back, please login to your account.</p>
                <p class="text-primary fw-bold">Selamat Datang di Klinik PET+CLINIC.</p>
            </div>
            
            <form id="loginForm" class="mt-4">
                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="mb-4">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary-custom btn-lg">Login</button>
                </div>
                <div id="loginMessage" class="mt-3 text-danger text-center" style="display:none;">
                    Username atau password salah!
                </div>
            </form>
        </div>
    </div>
</div>

<div id="dashboardPage" style="display:none;">
    <div class="sidebar">
        <div class="sidebar-header">
            <span class="d-none d-lg-inline">PET+CLINIC</span>
        </div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="#" data-page="dashboard"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-page="dokter"><i class="bi bi-person-badge me-2"></i> Dokter</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-page="pasien"><i class="bi bi-file-earmark-medical me-2"></i> Input Rekam Medis</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-page="ruang"><i class="bi bi-hospital me-2"></i> Ruang</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-page="rekam-medis"><i class="bi bi-journal-medical me-2"></i> Data Rekam Medis</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-page="pembayaran"><i class="bi bi-wallet2 me-2"></i> Pembayaran</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-page="laporan"><i class="bi bi-file-earmark-bar-graph me-2"></i> Laporan</a>
            </li>
        </ul>
        <div style="position: absolute; bottom: 0; padding: 10px 20px; font-size: 0.8rem; opacity: 0.7;">
            COPYRIGHT © 2021
        </div>
    </div>

    <div class="main-content">
        <div class="topbar">
            <button class="btn btn-outline-secondary d-lg-none me-3" onclick="toggleSidebar()">
                <i class="bi bi-list"></i>
            </button> 
            <div class="d-flex align-items-center ms-auto">
                <span class="me-3">admin | Available</span>
                <img src="https://via.placeholder.com/40" alt="Admin" class="rounded-circle">
                <button class="btn btn-sm btn-outline-secondary ms-3" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Logout</button>
            </div>
        </div>
        
        <div id="pageContent" class="page-content">
            </div>
    </div>
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div> 
</div>

<div class="modal fade" id="rekamMedisModal" tabindex="-1" aria-labelledby="rekamMedisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rekamMedisModalLabel">Detail Rekam Medis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="rekamMedisModalBody">
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-primary-custom" id="modalSaveBtn" style="display: none;">Simpan Perubahan</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const loginPage = document.getElementById('loginPage');
    const dashboardPage = document.getElementById('dashboardPage');
    const pageContent = document.getElementById('pageContent');

    // --- DATA SIMULASI (Pengganti Database) ---
    let dataDokter = JSON.parse(localStorage.getItem('dataDokter')) || [
        { id: 1, nama: "Johan", spesialis: "Hati", alamat: "Karawang", telp: "08987654321" },
        { id: 2, nama: "Lina", spesialis: "Kulit", alamat: "Jakarta", telp: "08123456789" },
    ];
    // PERUBAHAN: Menambahkan statusPembayaran dan dataPembayaran ke dataRekamMedis
    let dataRekamMedis = JSON.parse(localStorage.getItem('dataRekamMedis')) || [
        { 
            id: 101, tglPeriksa: "2023-03-04", namaPemilik: "Siti", nomorHpPemilik: "0812...", alamatPemilik: "Karawang", namaHewan: "Puss", jenisHewan: "Kucing", rasHewan: "Persia", jenisKelamin: "Betina", umurHewan: "2 th", anamnesa: "Demam tinggi 2 hari.", hr: "120", rr: "40", suhu: "40.1", bb: "3.5", crt: "<2s", mukosa: "Pink pucat", turgor: "Normal", tandaKlinis: "Tidak nafsu makan", diagnosaPasien: "Infeksi virus", keteranganTambahan: "Rawat inap 3 hari.", namaDokter: "Johan", obat: "Bodrex, Dosis: 1/2 tablet", ruang: "Melati 01", 
            statusPembayaran: "Lunas", 
            dataPembayaran: { konsultasi: 50000, rawatInapMalam: 3, operasi: 0, lainLain: 0, itemObat: [{id:1, qty:1}, {id:2, qty:0}] }
        },
        { 
            id: 102, tglPeriksa: "2023-03-05", namaPemilik: "Budi", nomorHpPemilik: "0899...", alamatPemilik: "Bekasi", namaHewan: "Doggy", jenisHewan: "Anjing", rasHewan: "Pom", jenisKelamin: "Jantan", umurHewan: "1 th", anamnesa: "Lemas dan muntah.", hr: "110", rr: "35", suhu: "38.5", bb: "2.1", crt: "<2s", mukosa: "Pink", turgor: "Normal", tandaKlinis: "Muntah 3x sehari", diagnosaPasien: "Gastroenteritis", keteranganTambahan: "Obat jalan", namaDokter: "Lina", obat: "Anti-muntah, Dosis: 1 kapsul", ruang: "", 
            statusPembayaran: "Belum Lunas",
            dataPembayaran: { konsultasi: 50000, rawatInapMalam: 0, operasi: 0, lainLain: 0, itemObat: [{id:1, qty:1}, {id:3, qty:1}] }
        },
    ];
    let dataRuang = JSON.parse(localStorage.getItem('dataRuang')) || [
        { id: 1, nama: "Melati 01" },
        { id: 2, nama: "Melati 02" },
        { id: 3, nama: "Anggrek 01" },
    ];
    
    // --- DATA Harga dan Biaya Dasar ---
    let dataHargaDasar = JSON.parse(localStorage.getItem('dataHargaDasar')) || {
        biayaKonsultasi: 50000,
        biayaRawatInapPerMalam: 100000,
        biayaOperasi: 500000,
        obatDanLayanan: [
            { id: 1, nama: "Parasetamol Hewan", harga: 15000 },
            { id: 2, nama: "Vaksin Distemper", harga: 75000 },
            { id: 3, nama: "Pemeriksaan Darah Lengkap", harga: 120000 },
        ]
    };

    function saveData() {
        localStorage.setItem('dataDokter', JSON.stringify(dataDokter));
        localStorage.setItem('dataRekamMedis', JSON.stringify(dataRekamMedis));
        localStorage.setItem('dataRuang', JSON.stringify(dataRuang)); // Simpan dataRuang
        localStorage.setItem('dataHargaDasar', JSON.stringify(dataHargaDasar)); 
    }
    
    // --- Logika Login/Logout ---
    document.getElementById('loginForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const usernameInput = document.getElementById('username').value;
        const passwordInput = document.getElementById('password').value;
        const loginMessage = document.getElementById('loginMessage');

        if (usernameInput === 'kelompok3' && passwordInput === 'satuduatiga') {
            loginPage.style.display = 'none';
            dashboardPage.style.display = 'block';
            renderDashboard(); 
        } else {
            loginMessage.style.display = 'block';
        }
    });

    function logout() {
        if(confirm('Apakah Anda yakin ingin logout?')) {
            dashboardPage.style.display = 'none';
            loginPage.style.display = 'flex';
            document.getElementById('loginForm').reset();
            document.getElementById('loginMessage').style.display = 'none';
        }
    }

    // --- Logika Sidebar Responsif (PERBAIKAN) ---
    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.toggle('active');
        overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
    }


    // --- UTILITY FUNCTIONS ---
    function setActiveLink(page) {
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('data-page') === page) {
                link.classList.add('active');
            }
        });
    }

    // B. Dashboard
    function renderDashboard() {
        const totalPasien = dataRekamMedis.length; 
        const totalDokter = dataDokter.length;
        const totalRuang = dataRuang.length;
        // Hitung Ruangan yang sedang terisi
        const ruangTerisi = new Set(dataRekamMedis.filter(rm => rm.ruang && rm.ruang !== '').map(rm => rm.ruang)).size;


        const content = `
            <h2>Dashboard</h2>
            <hr>
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card card-info p-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-person-badge display-4 text-primary me-3"></i>
                            <div>
                                <h4 class="mb-0">${totalDokter}</h4>
                                <p class="text-muted mb-0">Dokter</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card card-info p-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-person display-4 text-success me-3"></i>
                            <div>
                                <h4 class="mb-0">${totalPasien}</h4>
                                <p class="text-muted mb-0">Pasien Terdaftar</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card card-info p-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-hospital display-4 text-warning me-3"></i>
                            <div>
                                <h4 class="mb-0">${totalRuang} (${ruangTerisi} Terisi)</h4>
                                <p class="text-muted mb-0">Ruang</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card card-info p-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-prescription2 display-4 text-danger me-3"></i>
                            <div>
                                <h4 class="mb-0">${totalPasien}</h4>
                                <p class="text-muted mb-0">Jumlah Tindakan/Terapi</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="alert alert-info mt-4">
                Selamat Datang di sistem administrasi PET+CLINIC. Data di dashboard disinkronkan.
            </div>
        `;
        pageContent.innerHTML = content;
        setActiveLink('dashboard');
    }

    // C. Dokter (List & CRUD Logic) - Logika tetap sama
    function renderDokter() {
        const content = `
            <div id="dokterList">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Dokter</h2>
                    <button class="btn btn-primary-custom" onclick="renderTambahDokter()">
                        <i class="bi bi-plus-lg me-1"></i> Tambah Dokter
                    </button>
                </div>
                <hr>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Nama</th>
                                <th>Spesialis</th>
                                <th>Alamat</th>
                                <th>Nomor Telepon</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dataDokter.map((d, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${d.nama}</td>
                                    <td>${d.spesialis}</td>
                                    <td>${d.alamat}</td>
                                    <td>${d.telp}</td>
                                    <td>
                                        <button class="btn btn-sm btn-info text-white" onclick="renderTambahDokter(${d.id})"><i class="bi bi-pencil"></i> Edit</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteDokter(${d.id})"><i class="bi bi-trash"></i> Hapus</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        pageContent.innerHTML = content;
        setActiveLink('dokter');
    }

    function renderTambahDokter(idToEdit = null) {
        const dokter = idToEdit ? dataDokter.find(d => d.id === idToEdit) : {};
        const isEdit = !!idToEdit;

        const form = `
            <h2>${isEdit ? 'Edit' : 'Tambah'} Dokter</h2>
            <hr>
            <form id="formDokter" onsubmit="handleDokterSubmit(event, ${idToEdit})">
                <div class="mb-3">
                    <label for="namaDokter" class="form-label">Nama</label>
                    <input type="text" class="form-control" id="namaDokter" value="${dokter.nama || ''}" required>
                </div>
                <div class="mb-3">
                    <label for="nomorHpDokter" class="form-label">Nomor HP</label>
                    <input type="tel" class="form-control" id="nomorHpDokter" value="${dokter.telp || ''}" required>
                </div>
                <div class="mb-3">
                    <label for="alamatDokter" class="form-label">Alamat</label>
                    <textarea class="form-control" id="alamatDokter" rows="3" required>${dokter.alamat || ''}</textarea>
                </div>
                <div class="mb-4">
                    <label for="spesialisDokter" class="form-label">Spesialis</label>
                    <input type="text" class="form-control" id="spesialisDokter" value="${dokter.spesialis || ''}" required>
                </div>
                
                <button type="submit" class="btn btn-primary-custom me-2">${isEdit ? 'Simpan Perubahan' : 'Simpan'}</button>
                <button type="button" class="btn btn-secondary" onclick="renderDokter()">Kembali</button>
            </form>
        `;
        pageContent.innerHTML = form;
    }

    function handleDokterSubmit(event, idToEdit) {
        event.preventDefault();
        const nama = document.getElementById('namaDokter').value;
        const telp = document.getElementById('nomorHpDokter').value;
        const alamat = document.getElementById('alamatDokter').value;
        const spesialis = document.getElementById('spesialisDokter').value;

        if (idToEdit) {
            const index = dataDokter.findIndex(d => d.id === idToEdit);
            if (index !== -1) {
                dataDokter[index] = { ...dataDokter[index], nama, telp, alamat, spesialis };
            }
            alert("Data Dokter berhasil diubah!");
        } else {
            const newId = dataDokter.length > 0 ? Math.max(...dataDokter.map(d => d.id)) + 1 : 1;
            dataDokter.push({ id: newId, nama, telp, alamat, spesialis });
            alert("Data Dokter berhasil ditambahkan!");
        }
        
        saveData();
        renderDokter(); 
        renderDashboard(); 
    }

    function deleteDokter(id) {
        if (confirm("Apakah Anda yakin ingin menghapus data Dokter ini?")) {
            dataDokter = dataDokter.filter(d => d.id !== id);
            saveData();
            renderDokter();
            renderDashboard(); 
            alert("Data Dokter berhasil dihapus.");
        }
    }


    // D. Input Rekam Medis (Pasien) - Diperbarui untuk sinkronisasi pembayaran
    function renderPasien() {
        const content = `
            <h2>Input Rekam Medis Baru</h2>
            <hr>
            <form id="formTambahRekamMedis" onsubmit="handleRekamMedisSubmit(event)">
                
                <h4 class="mt-4 mb-3">Data Pemilik & Jadwal</h4>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="namaPemilik" class="form-label">Nama Pemilik</label>
                        <input type="text" class="form-control" id="namaPemilik" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="nomorHpPemilik" class="form-label">Nomor HP</label>
                        <input type="tel" class="form-control" id="nomorHpPemilik" required>
                    </div>
                    <div class="col-12 mb-3">
                        <label for="alamatPemilik" class="form-label">Alamat</label>
                        <textarea class="form-control" id="alamatPemilik" rows="2" required></textarea>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="tanggalPeriksa" class="form-label">Tanggal Hewan Periksa</label>
                        <input type="date" class="form-control" id="tanggalPeriksa" value="${new Date().toISOString().substring(0, 10)}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="namaDokter" class="form-label">Dokter Pemeriksa</label>
                        <select class="form-select" id="namaDokter" required>
                            <option value="">Pilih Dokter</option>
                            ${dataDokter.map(d => `<option value="${d.nama}">${d.nama} (${d.spesialis})</option>`).join('')}
                        </select>
                    </div>
                </div>

                <h4 class="mt-4 mb-3">Data Hewan</h4>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="namaHewan" class="form-label">Nama Hewan</label>
                        <input type="text" class="form-control" id="namaHewan" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="jenisHewan" class="form-label">Jenis Hewan</label>
                        <input type="text" class="form-control" id="jenisHewan" placeholder="Contoh: Kucing/Anjing" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="rasHewan" class="form-label">Ras Hewan</label>
                        <input type="text" class="form-control" id="rasHewan">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="jenisKelamin" class="form-label">Jenis Kelamin</label>
                        <select class="form-select" id="jenisKelamin" required>
                            <option value="">Pilih...</option>
                            <option>Jantan</option>
                            <option>Betina</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="umurHewan" class="form-label">Umur Hewan</label>
                        <input type="text" class="form-control" id="umurHewan" placeholder="Contoh: 1 tahun 3 bulan">
                    </div>
                    <div class="col-12 mb-3">
                        <label for="anamnesa" class="form-label">Anamnesa (Keluhan Utama)</label>
                        <textarea class="form-control" id="anamnesa" rows="3" required></textarea>
                    </div>
                </div>

                <h4 class="mt-4 mb-3">Pemeriksaan Fisik</h4>
                <div class="row">
                    <div class="col-md-3 mb-3"> <label for="hr" class="form-label">Heart Rate (HR)</label> <input type="text" class="form-control" id="hr"> </div>
                    <div class="col-md-3 mb-3"> <label for="rr" class="form-label">Respiration Rate (RR)</label> <input type="text" class="form-control" id="rr"> </div>
                    <div class="col-md-3 mb-3"> <label for="suhu" class="form-label">Suhu (°C)</label> <input type="number" step="0.1" class="form-control" id="suhu"> </div>
                    <div class="col-md-3 mb-3"> <label for="bb" class="form-label">Berat Badan (BB) (kg)</label> <input type="number" step="0.1" class="form-control" id="bb"> </div>
                    <div class="col-md-3 mb-3"> <label for="crt" class="form-label">CRT (Capillary Refill Time)</label> <input type="text" class="form-control" id="crt"> </div>
                    <div class="col-md-3 mb-3"> <label for="mukosa" class="form-label">Mukosa</label> <input type="text" class="form-control" id="mukosa"> </div>
                    <div class="col-md-3 mb-3"> <label for="turgor" class="form-label">Turgor Kulit</label> <input type="text" class="form-control" id="turgor"> </div>
                    <div class="col-md-3 mb-3"> <label for="tandaKlinis" class="form-label">Tanda Klinis Lain</label> <input type="text" class="form-control" id="tandaKlinis"> </div>
                </div>

                <h4 class="mt-4 mb-3">Diagnosa & Tindakan</h4>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="diagnosaPasien" class="form-label">Diagnosa</label>
                        <textarea class="form-control" id="diagnosaPasien" rows="2" required></textarea>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="obatPasien" class="form-label">Obat/Terapi yang Diberikan (Dosis & Keterangan)</label>
                        <textarea class="form-control" id="obatPasien" rows="2"></textarea>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="ruangRawat" class="form-label">Ruang Rawat (Jika Perlu)</label>
                        <select class="form-select" id="ruangRawat">
                            <option value="">Tidak Dirawat</option>
                            ${dataRuang.map(r => `<option value="${r.nama}">${r.nama}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="keteranganTambahan" class="form-label">Keterangan Tambahan</label>
                        <textarea class="form-control" id="keteranganTambahan" rows="2"></textarea>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary-custom me-2 mt-3">Simpan Rekam Medis & Lanjut Pembayaran</button>
            </form>
        `;
        pageContent.innerHTML = content;
        setActiveLink('pasien');
    }

    function handleRekamMedisSubmit(event) {
        event.preventDefault();

        const form = event.target;
        const newId = dataRekamMedis.length > 0 ? Math.max(...dataRekamMedis.map(r => r.id)) + 1 : 101;
        
        const newRecord = {
            id: newId,
            tglPeriksa: form.tanggalPeriksa.value,
            namaPemilik: form.namaPemilik.value,
            nomorHpPemilik: form.nomorHpPemilik.value,
            alamatPemilik: form.alamatPemilik.value,
            namaHewan: form.namaHewan.value,
            jenisHewan: form.jenisHewan.value,
            rasHewan: form.rasHewan.value,
            jenisKelamin: form.jenisKelamin.value,
            umurHewan: form.umurHewan.value,
            anamnesa: form.anamnesa.value,
            hr: form.hr.value,
            rr: form.rr.value,
            suhu: form.suhu.value,
            bb: form.bb.value,
            crt: form.crt.value,
            mukosa: form.mukosa.value,
            turgor: form.turgor.value,
            tandaKlinis: form.tandaKlinis.value,
            diagnosaPasien: form.diagnosaPasien.value,
            keteranganTambahan: form.keteranganTambahan.value,
            namaDokter: form.namaDokter.value,
            obat: form.obatPasien.value,
            ruang: form.ruangRawat.value,
            // DATA BARU: Status Pembayaran default dan inisialisasi data pembayaran
            statusPembayaran: "Belum Lunas",
            dataPembayaran: { 
                konsultasi: dataHargaDasar.biayaKonsultasi, // Set default konsultasi
                rawatInapMalam: form.ruangRawat.value !== '' ? 1 : 0, // Jika dirawat, set 1 malam
                operasi: 0, 
                lainLain: 0, 
                itemObat: [] // Dibiarkan kosong, diisi di halaman pembayaran
            }
        };

        dataRekamMedis.push(newRecord);
        saveData();
        renderDashboard(); // Sinkronkan Dashboard
        form.reset();
        alert("Rekam Medis baru berhasil disimpan! Silakan input detail pembayaran.");
        
        // LANGSUNG PINDAH KE HALAMAN PEMBAYARAN UNTUK REKAM MEDIS YANG BARU DIBUAT
        renderPembayaranRekamMedis(newId);
    }

    // E. Data Rekam Medis (List, Search & CRUD Logic) - Diperbarui untuk menampilkan status
    function renderRekamMedis() {
        const displayData = dataRekamMedis;

        const content = `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>Data Rekam Medis</h2>
                <button class="btn btn-primary-custom" onclick="renderPasien()">
                    <i class="bi bi-plus-lg me-1"></i> Tambah Rekam Medis
                </button>
            </div>
            <hr>
            
            <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="Cari berdasarkan Nama Pemilik atau Nama Hewan..." id="searchInput" onkeyup="searchRekamMedis()">
                <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('searchInput').value=''; searchRekamMedis();">
                    <i class="bi bi-x-lg"></i> Clear
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Tgl Periksa</th>
                            <th>Nama Pemilik</th>
                            <th>Nama Hewan</th>
                            <th>Diagnosa</th>
                            <th>Dokter</th>
                            <th>Status Pembayaran</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="rekamMedisTableBody">
                        ${generateRekamMedisTableRows(displayData)}
                    </tbody>
                </table>
            </div>
        `;
        pageContent.innerHTML = content;
        setActiveLink('rekam-medis');
    }

    // Fungsi untuk menghasilkan baris tabel
    function generateRekamMedisTableRows(data) {
        if (data.length === 0) {
            return `<tr><td colspan="7" class="text-center text-muted">Tidak ada data rekam medis ditemukan.</td></tr>`;
        }
        return data.map((rm) => {
            const statusBadge = rm.statusPembayaran === "Lunas" 
                ? `<span class="badge bg-success">${rm.statusPembayaran}</span>`
                : `<span class="badge bg-danger">${rm.statusPembayaran}</span>`;
            
            return `
                <tr>
                    <td>${rm.tglPeriksa}</td>
                    <td>${rm.namaPemilik}</td>
                    <td>${rm.namaHewan}</td>
                    <td>${rm.diagnosaPasien}</td>
                    <td>${rm.namaDokter}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-warning text-dark" onclick="renderPembayaranRekamMedis(${rm.id})"><i class="bi bi-wallet-fill"></i> Bayar</button>
                        <button class="btn btn-sm btn-info text-white" onclick="viewRekamMedisDetail(${rm.id}, true)"><i class="bi bi-pencil"></i> Edit RM</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRekamMedis(${rm.id})"><i class="bi bi-trash"></i> Hapus</button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Fungsi Logika Pencarian
    function searchRekamMedis() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
        let filteredData;

        if (searchTerm === "") {
            filteredData = dataRekamMedis; 
        } else {
            filteredData = dataRekamMedis.filter(rm => 
                rm.namaPemilik.toLowerCase().includes(searchTerm) ||
                rm.namaHewan.toLowerCase().includes(searchTerm)
            );
        }

        document.getElementById('rekamMedisTableBody').innerHTML = generateRekamMedisTableRows(filteredData);
    }
    
    function viewRekamMedisDetail(id, isEdit) {
        const record = dataRekamMedis.find(r => r.id === id);
        if (!record) return alert("Data tidak ditemukan.");

        const doctorOptions = dataDokter.map(d => 
            `<option value="${d.nama}" ${record.namaDokter === d.nama ? 'selected' : ''}>${d.nama} (${d.spesialis})</option>`
        ).join('');
        const ruangOptions = dataRuang.map(r => 
            `<option value="${r.nama}" ${record.ruang === r.nama ? 'selected' : ''}>${r.nama}</option>`
        ).join('');
        
        const disabled = isEdit ? '' : 'disabled';

        // Konten Modal (HTML Form yang sama dengan input pasien, tapi diisi data)
        const modalBodyContent = `
            <form id="formEditRekamMedis" data-id="${id}">
                <h5 class="mt-2 mb-3 text-primary">${isEdit ? 'Mode Edit' : 'Mode Lihat Detail'}</h5>
                
                <h6>Data Umum</h6>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">Tanggal Periksa</label><input type="date" class="form-control" id="modal_tglPeriksa" value="${record.tglPeriksa}" ${disabled}></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Dokter</label><select class="form-select" id="modal_namaDokter" ${disabled}><option value="">Pilih Dokter</option>${doctorOptions}</select></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Nama Pemilik</label><input type="text" class="form-control" id="modal_namaPemilik" value="${record.namaPemilik}" ${disabled}></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Nomor HP</label><input type="tel" class="form-control" id="modal_nomorHpPemilik" value="${record.nomorHpPemilik}" ${disabled}></div>
                    <div class="col-12 mb-3"><label class="form-label">Alamat Pemilik</label><textarea class="form-control" id="modal_alamatPemilik" rows="2" ${disabled}>${record.alamatPemilik}</textarea></div>
                </div>

                <h6>Data Hewan & Anamnesa</h6>
                <div class="row">
                    <div class="col-md-4 mb-3"><label class="form-label">Nama Hewan</label><input type="text" class="form-control" id="modal_namaHewan" value="${record.namaHewan}" ${disabled}></div>
                    <div class="col-md-4 mb-3"><label class="form-label">Jenis Hewan</label><input type="text" class="form-control" id="modal_jenisHewan" value="${record.jenisHewan}" ${disabled}></div>
                    <div class="col-md-4 mb-3"><label class="form-label">Ras Hewan</label><input type="text" class="form-control" id="modal_rasHewan" value="${record.rasHewan}" ${disabled}></div>
                    <div class="col-md-4 mb-3"><label class="form-label">J. Kelamin</label><input type="text" class="form-control" id="modal_jenisKelamin" value="${record.jenisKelamin}" ${disabled}></div>
                    <div class="col-md-4 mb-3"><label class="form-label">Umur Hewan</label><input type="text" class="form-control" id="modal_umurHewan" value="${record.umurHewan}" ${disabled}></div>
                    <div class="col-12 mb-3"><label class="form-label">Anamnesa (Keluhan)</label><textarea class="form-control" id="modal_anamnesa" rows="3" ${disabled}>${record.anamnesa}</textarea></div>
                </div>
                
                <h6>Pemeriksaan Fisik</h6>
                <div class="row">
                    <div class="col-md-3 mb-3"><label class="form-label">HR</label><input type="text" class="form-control" id="modal_hr" value="${record.hr}" ${disabled}></div>
                    <div class="col-md-3 mb-3"><label class="form-label">RR</label><input type="text" class="form-control" id="modal_rr" value="${record.rr}" ${disabled}></div>
                    <div class="col-md-3 mb-3"><label class="form-label">Suhu</label><input type="text" class="form-control" id="modal_suhu" value="${record.suhu}" ${disabled}></div>
                    <div class="col-md-3 mb-3"><label class="form-label">BB</label><input type="text" class="form-control" id="modal_bb" value="${record.bb}" ${disabled}></div>
                    <div class="col-md-3 mb-3"><label class="form-label">CRT</label><input type="text" class="form-control" id="modal_crt" value="${record.crt}" ${disabled}></div>
                    <div class="col-md-3 mb-3"><label class="form-label">Mukosa</label><input type="text" class="form-control" id="modal_mukosa" value="${record.mukosa}" ${disabled}></div>
                    <div class="col-md-3 mb-3"><label class="form-label">Turgor</label><input type="text" class="form-control" id="modal_turgor" value="${record.turgor}" ${disabled}></div>
                    <div class="col-md-3 mb-3"><label class="form-label">Tanda Klinis</label><input type="text" class="form-control" id="modal_tandaKlinis" value="${record.tandaKlinis}" ${disabled}></div>
                </div>

                <h6>Diagnosa & Tindakan</h6>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">Diagnosa</label><textarea class="form-control" id="modal_diagnosaPasien" rows="2" ${disabled}>${record.diagnosaPasien}</textarea></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Obat/Terapi</label><textarea class="form-control" id="modal_obatPasien" rows="2" ${disabled}>${record.obat}</textarea></div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Ruang Rawat</label>
                        <select class="form-select" id="modal_ruangRawat" ${disabled}>
                            <option value="">Tidak Dirawat</option>
                            ${ruangOptions}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3"><label class="form-label">Keterangan Tambahan</label><textarea class="form-control" id="modal_keteranganTambahan" rows="2" ${disabled}>${record.keteranganTambahan}</textarea></div>
                </div>
            </form>
        `;

        document.getElementById('rekamMedisModalLabel').textContent = isEdit ? 'Edit Rekam Medis #' + id : 'Detail Rekam Medis #' + id;
        document.getElementById('rekamMedisModalBody').innerHTML = modalBodyContent;
        document.getElementById('modalSaveBtn').style.display = isEdit ? 'block' : 'none';

        if (isEdit) {
            document.getElementById('modalSaveBtn').onclick = () => saveRekamMedisEdit(id);
        }

        const modal = new bootstrap.Modal(document.getElementById('rekamMedisModal'));
        modal.show();
    }

    function saveRekamMedisEdit(id) {
        const index = dataRekamMedis.findIndex(r => r.id === id);
        if (index === -1) return;

        const form = document.getElementById('formEditRekamMedis');
        
        dataRekamMedis[index] = {
            ...dataRekamMedis[index],
            tglPeriksa: form.modal_tglPeriksa.value,
            namaPemilik: form.modal_namaPemilik.value,
            nomorHpPemilik: form.modal_nomorHpPemilik.value,
            alamatPemilik: form.modal_alamatPemilik.value,
            namaHewan: form.modal_namaHewan.value,
            jenisHewan: form.modal_jenisHewan.value,
            rasHewan: form.modal_rasHewan.value,
            jenisKelamin: form.modal_jenisKelamin.value,
            umurHewan: form.modal_umurHewan.value,
            anamnesa: form.modal_anamnesa.value,
            hr: form.modal_hr.value,
            rr: form.modal_rr.value,
            suhu: form.modal_suhu.value,
            bb: form.modal_bb.value,
            crt: form.modal_crt.value,
            mukosa: form.modal_mukosa.value,
            turgor: form.modal_turgor.value,
            tandaKlinis: form.modal_tandaKlinis.value,
            diagnosaPasien: form.modal_diagnosaPasien.value,
            keteranganTambahan: form.modal_keteranganTambahan.value,
            namaDokter: form.modal_namaDokter.value,
            obat: form.modal_obatPasien.value,
            ruang: form.modal_ruangRawat.value,
            // statusPembayaran tidak diubah di sini, hanya di modul pembayaran
        };

        saveData();
        bootstrap.Modal.getInstance(document.getElementById('rekamMedisModal')).hide();
        renderRekamMedis();
        renderDashboard();
        alert("Perubahan Rekam Medis berhasil disimpan!");
    }

    function deleteRekamMedis(id) {
        if (confirm("Apakah Anda yakin ingin menghapus Rekam Medis ini?")) {
            dataRekamMedis = dataRekamMedis.filter(r => r.id !== id);
            saveData();
            renderRekamMedis();
            renderDashboard(); // Sinkronkan dashboard
            alert("Rekam Medis berhasil dihapus.");
        }
    }
    
    // F. Ruang (Dengan CRUD Logic)
    function renderRuang() {
        // Tentukan ruangan mana yang sedang terisi
        const ruanganTerisi = dataRekamMedis.filter(rm => rm.ruang && rm.ruang !== '').map(rm => rm.ruang);

        const content = `
            <div id="ruangList">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Data Ruangan Klinik</h2>
                    <button class="btn btn-primary-custom" onclick="renderTambahRuang()">
                        <i class="bi bi-plus-lg me-1"></i> Tambah Ruangan
                    </button>
                </div>
                <hr>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Nama Ruangan</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dataRuang.map((r, index) => {
                                const isOccupied = ruanganTerisi.includes(r.nama);
                                const statusBadge = isOccupied 
                                    ? `<span class="badge bg-danger">Terisi (${ruanganTerisi.filter(n => n === r.nama).length} Pasien)</span>` 
                                    : '<span class="badge bg-success">Tersedia</span>';
                                return `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${r.nama}</td>
                                        <td>${statusBadge}</td>
                                        <td>
                                            <button class="btn btn-sm btn-info text-white" onclick="renderTambahRuang(${r.id})"><i class="bi bi-pencil"></i> Edit Nama</button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteRuang(${r.id}, ${isOccupied})"><i class="bi bi-trash"></i> Hapus</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        pageContent.innerHTML = content;
        setActiveLink('ruang');
    }

    // F. Ruang (Form Tambah/Edit)
    function renderTambahRuang(idToEdit = null) {
        const ruang = idToEdit ? dataRuang.find(r => r.id === idToEdit) : {};
        const isEdit = !!idToEdit;

        const form = `
            <h2>${isEdit ? 'Edit' : 'Tambah'} Ruangan</h2>
            <hr>
            <form id="formRuang" onsubmit="handleRuangSubmit(event, ${idToEdit})">
                <div class="mb-3">
                    <label for="namaRuang" class="form-label">Nama Ruangan</label>
                    <input type="text" class="form-control" id="namaRuang" value="${ruang.nama || ''}" required>
                </div>
                
                <button type="submit" class="btn btn-primary-custom me-2">${isEdit ? 'Simpan Perubahan' : 'Simpan'}</button>
                <button type="button" class="btn btn-secondary" onclick="renderRuang()">Kembali</button>
            </form>
        `;
        pageContent.innerHTML = form;
    }

    function handleRuangSubmit(event, idToEdit) {
        event.preventDefault();
        const namaBaru = document.getElementById('namaRuang').value;

        if (idToEdit) {
            // Edit
            const index = dataRuang.findIndex(r => r.id === idToEdit);
            if (index !== -1) {
                const namaLama = dataRuang[index].nama;
                dataRuang[index] = { ...dataRuang[index], nama: namaBaru };
                
                // Update nama ruangan di data Rekam Medis yang terkait
                dataRekamMedis.forEach(rm => {
                    if (rm.ruang === namaLama) {
                        rm.ruang = namaBaru;
                    }
                });
            }
            alert("Nama Ruangan berhasil diubah!");
        } else {
            // Tambah Baru
            const newId = dataRuang.length > 0 ? Math.max(...dataRuang.map(r => r.id)) + 1 : 1;
            dataRuang.push({ id: newId, nama: namaBaru });
            alert("Ruangan baru berhasil ditambahkan!");
        }
        
        saveData();
        renderRuang(); // Kembali ke daftar
        renderDashboard(); // Sinkronkan dashboard
    }

    function deleteRuang(id, isOccupied) {
        if (isOccupied) {
            return alert("Gagal menghapus! Ruangan ini masih terisi oleh pasien. Mohon kosongkan ruangan terlebih dahulu.");
        }
        
        if (confirm("Apakah Anda yakin ingin menghapus Ruangan ini?")) {
            const namaRuangDihapus = dataRuang.find(r => r.id === id).nama;
            dataRuang = dataRuang.filter(r => r.id !== id);
            
            // Hapus referensi ruangan ini di Rekam Medis
            dataRekamMedis.forEach(rm => {
                if (rm.ruang === namaRuangDihapus) {
                    rm.ruang = ''; // Set ke kosong
                }
            });

            saveData();
            renderRuang();
            renderDashboard(); 
            alert("Ruangan berhasil dihapus.");
        }
    }
    
    // G. Laporan - Tetap sama
    function renderLaporan() {
        const content = `
            <h2>Laporan Rekam Medis</h2>
            <hr>
            <p>Pilih rentang waktu untuk mengunduh laporan Rekam Medis:</p>
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="startDate" class="form-label">Tanggal Mulai</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="col-md-4">
                    <label for="endDate" class="form-label">Tanggal Akhir</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="col-md-4 align-self-end">
                    <button class="btn btn-success w-100" onclick="downloadReport()">
                        <i class="bi bi-download me-2"></i> Unduh Laporan
                    </button>
                </div>
            </div>
            <div class="mt-4">
                <button class="btn btn-outline-primary me-2" onclick="setReportRange(7)">1 Minggu Terakhir</button>
                <button class="btn btn-outline-primary me-2" onclick="setReportRange(30)">1 Bulan Terakhir</button>
            </div>
            <p class="text-muted mt-4">Catatan: Proses unduhan ini adalah simulasi. Dalam aplikasi nyata, ini akan menghasilkan file PDF/Excel.</p>
        `;
        pageContent.innerHTML = content;
        setActiveLink('laporan');
    }

    function setReportRange(days) {
        const today = new Date();
        const start = new Date(today);
        start.setDate(today.getDate() - days);

        document.getElementById('endDate').value = today.toISOString().substring(0, 10);
        document.getElementById('startDate').value = start.toISOString().substring(0, 10);
        alert(`Rentang waktu diatur ke ${days} hari terakhir.`);
    }

    function downloadReport() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        
        if (!start || !end) {
            return alert("Mohon pilih tanggal mulai dan tanggal akhir.");
        }

        const filteredData = dataRekamMedis.filter(r => 
            r.tglPeriksa >= start && r.tglPeriksa <= end
        );

        alert(`Simulasi Unduh Laporan:\nRentang: ${start} sampai ${end}\nJumlah Data Ditemukan: ${filteredData.length} entri.\n\n(Laporan akan diunduh dalam format PDF/Excel di sistem nyata.)`);
    }

    // H. Pembayaran (Pengaturan Harga Dasar) - Fungsi utama dipecah untuk menampung detail pasien
    function renderPembayaran() {
        const content = `
            <h2>Pengaturan Harga Dasar & Perhitungan Pembayaran</h2>
            <hr>
            <p class="alert alert-info">Pilih aksi: 
                <button class="btn btn-sm btn-primary-custom" onclick="renderPengaturanHarga()">Pengaturan Harga Dasar</button> 
                atau 
                <button class="btn btn-sm btn-success" onclick="renderDaftarTagihan()">Lihat Daftar Tagihan Pasien</button>
            </p>
            <div id="pembayaranContent">
                ${renderPengaturanHargaContent()}
            </div>
        `;
        pageContent.innerHTML = content;
        setActiveLink('pembayaran');
    }

    function renderPengaturanHarga() {
        document.getElementById('pembayaranContent').innerHTML = renderPengaturanHargaContent();
    }

    function renderPengaturanHargaContent() {
        return `
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card p-3 shadow-sm">
                        <h4><i class="bi bi-cash-stack me-2"></i> Harga Layanan Dasar Klinik</h4>
                        <p class="text-muted">Atur biaya konsultasi, rawat inap, dan operasi.</p>
                        <form id="formHargaDasar" onsubmit="handleHargaDasarSubmit(event)">
                            <div class="mb-3">
                                <label for="biayaKonsultasi" class="form-label">Biaya Konsultasi Dokter (Rp)</label>
                                <input type="number" class="form-control" id="biayaKonsultasi" value="${dataHargaDasar.biayaKonsultasi}" required>
                            </div>
                            <div class="mb-3">
                                <label for="biayaRawatInapPerMalam" class="form-label">Biaya Rawat Inap per Malam (Rp)</label>
                                <input type="number" class="form-control" id="biayaRawatInapPerMalam" value="${dataHargaDasar.biayaRawatInapPerMalam}" required>
                            </div>
                            <div class="mb-4">
                                <label for="biayaOperasi" class="form-label">Biaya Operasi (Rp)</label>
                                <input type="number" class="form-control" id="biayaOperasi" value="${dataHargaDasar.biayaOperasi}" required>
                            </div>
                            <button type="submit" class="btn btn-primary-custom"><i class="bi bi-save me-1"></i> Simpan Harga Dasar</button>
                        </form>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card p-3 shadow-sm">
                        <h4><i class="bi bi-capsule me-2"></i> Daftar Harga Obat/Item Lain</h4>
                        <div id="listObat">
                            <ul class="list-group mb-3">
                                ${dataHargaDasar.obatDanLayanan.map(item => `
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        ${item.nama}
                                        <div>
                                            Rp ${item.harga.toLocaleString('id-ID')}
                                            <button class="btn btn-sm btn-danger ms-2" onclick="deleteObat(${item.id})"><i class="bi bi-x-lg"></i></button>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>

                        <h6>Tambah Item Baru</h6>
                        <form id="formTambahObat" onsubmit="handleTambahObatSubmit(event)">
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <input type="text" class="form-control" id="namaObat" placeholder="Nama Item/Obat" required>
                                </div>
                                <div class="col-6 mb-3">
                                    <input type="number" class="form-control" id="hargaObat" placeholder="Harga (Rp)" required>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-outline-primary w-100"><i class="bi bi-plus-lg me-1"></i> Tambah Item</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;
    }

    function renderDaftarTagihan() {
        const tagihanRows = dataRekamMedis.map(rm => {
            const totalTagihan = calculateTagihan(rm.dataPembayaran);
            const statusBadge = rm.statusPembayaran === "Lunas" 
                ? `<span class="badge bg-success">${rm.statusPembayaran}</span>`
                : `<span class="badge bg-danger">${rm.statusPembayaran}</span>`;

            return `
                <tr>
                    <td>#${rm.id}</td>
                    <td>${rm.namaHewan} (${rm.namaPemilik})</td>
                    <td>Rp ${totalTagihan.toLocaleString('id-ID')}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-warning text-dark" onclick="renderPembayaranRekamMedis(${rm.id})">Proses Bayar</button>
                    </td>
                </tr>
            `;
        }).join('');

        const content = `
            <h3>Daftar Tagihan Pasien</h3>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID RM</th>
                            <th>Pasien (Pemilik)</th>
                            <th>Total Tagihan</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tagihanRows}
                    </tbody>
                </table>
            </div>
        `;
        document.getElementById('pembayaranContent').innerHTML = content;
    }

    function renderPembayaranRekamMedis(id) {
        const record = dataRekamMedis.find(r => r.id === id);
        if (!record) return alert("Rekam Medis tidak ditemukan.");

        const initialData = record.dataPembayaran;
        let totalTagihan = calculateTagihan(initialData);

        const itemInputs = dataHargaDasar.obatDanLayanan.map(item => {
            const itemData = initialData.itemObat.find(i => i.id === item.id) || { qty: 0 };
            return `
                <div class="mb-3 row">
                    <label for="item_${item.id}" class="col-7 col-form-label">${item.nama} (Rp ${item.harga.toLocaleString('id-ID')})</label>
                    <div class="col-5">
                        <input type="number" class="form-control item-obat" id="item_${item.id}" data-price="${item.harga}" data-id="${item.id}" value="${itemData.qty}" min="0" placeholder="Qty">
                    </div>
                </div>
            `;
        }).join('');
        
        const statusBadge = record.statusPembayaran === "Lunas" 
            ? `<span class="badge bg-success fs-5">${record.statusPembayaran}</span>`
            : `<span class="badge bg-danger fs-5">${record.statusPembayaran}</span>`;

        const content = `
            <h3><i class="bi bi-receipt me-2"></i> Proses Pembayaran Rekam Medis #${record.id}</h3>
            <p>Pasien: <strong>${record.namaHewan}</strong> (Pemilik: ${record.namaPemilik}) | Status: ${statusBadge}</p>
            <hr>
            
            <form id="formHitungTagihan" oninput="calculateAndDisplayTagihan(${id})">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Biaya Layanan</h6>
                        <div class="mb-3">
                            <label for="biayaKonsultasiTagihan" class="form-label">Biaya Konsultasi (Rp ${dataHargaDasar.biayaKonsultasi.toLocaleString('id-ID')})</label>
                            <input type="number" class="form-control" id="biayaKonsultasiTagihan" value="${initialData.konsultasi}" min="0">
                        </div>
                        <div class="mb-3">
                            <label for="lamaRawatInap" class="form-label">Lama Rawat Inap (Malam)</label>
                            <input type="number" class="form-control" id="lamaRawatInap" value="${initialData.rawatInapMalam}" min="0">
                            <small class="text-muted">Biaya per malam: Rp ${dataHargaDasar.biayaRawatInapPerMalam.toLocaleString('id-ID')}</small>
                        </div>
                        <div class="mb-3">
                            <label for="biayaOperasiTagihan" class="form-label">Biaya Operasi (Rp)</label>
                            <input type="number" class="form-control" id="biayaOperasiTagihan" value="${initialData.operasi}" min="0">
                            <small class="text-muted">Biaya dasar: Rp ${dataHargaDasar.biayaOperasi.toLocaleString('id-ID')}</small>
                        </div>
                        <div class="mb-3">
                            <label for="biayaLainLain" class="form-label">Biaya Lain-lain (Rp)</label>
                            <input type="number" class="form-control" id="biayaLainLain" value="${initialData.lainLain}" min="0">
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h6>Biaya Obat/Item Tambahan</h6>
                        ${itemInputs}
                    </div>
                </div>

                <div class="alert alert-warning mt-4">
                    <h4><i class="bi bi-currency-dollar me-2"></i> TOTAL TAGIHAN: <span id="totalTagihanDisplay">Rp ${totalTagihan.toLocaleString('id-ID')}</span></h4>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-secondary" onclick="renderPembayaran()">Kembali ke Pembayaran</button>
                    <div>
                        <button type="button" class="btn btn-primary-custom me-2" onclick="savePembayaranData(${record.id})"><i class="bi bi-save me-1"></i> Simpan Detail Tagihan</button>
                        <button type="button" class="btn btn-success" onclick="markLunas(${record.id})"><i class="bi bi-check-circle me-1"></i> Tandai Lunas</button>
                    </div>
                </div>
            </form>
        `;
        pageContent.innerHTML = content;
        setActiveLink('pembayaran');
    }

    function calculateTagihan(dataPembayaran) {
        if (!dataPembayaran) return 0;

        // 1. Biaya Layanan
        const konsultasi = dataPembayaran.konsultasi || 0;
        const lamaRawatInap = dataPembayaran.rawatInapMalam || 0;
        const operasi = dataPembayaran.operasi || 0;
        const biayaLainLain = dataPembayaran.lainLain || 0;
        
        const rawatInapTotal = lamaRawatInap * dataHargaDasar.biayaRawatInapPerMalam;
        let totalLayanan = konsultasi + rawatInapTotal + operasi + biayaLainLain;

        // 2. Biaya Obat/Item Tambahan
        let totalObat = 0;
        dataPembayaran.itemObat.forEach(itemRecord => {
            const itemBase = dataHargaDasar.obatDanLayanan.find(i => i.id === itemRecord.id);
            if (itemBase && itemRecord.qty > 0) {
                totalObat += itemRecord.qty * itemBase.harga;
            }
        });

        return totalLayanan + totalObat;
    }

    function calculateAndDisplayTagihan(id) {
        const data = collectCurrentPembayaranData();
        const total = calculateTagihan(data);
        document.getElementById('totalTagihanDisplay').textContent = 'Rp ' + total.toLocaleString('id-ID');
    }
    
    function collectCurrentPembayaranData() {
        // Mengambil data terbaru dari form input
        const itemObatArray = [];
        document.querySelectorAll('.item-obat').forEach(input => {
            const qty = parseInt(input.value || 0);
            const id = parseInt(input.getAttribute('data-id'));
            itemObatArray.push({ id, qty });
        });

        return {
            konsultasi: parseInt(document.getElementById('biayaKonsultasiTagihan')?.value || 0),
            rawatInapMalam: parseInt(document.getElementById('lamaRawatInap')?.value || 0),
            operasi: parseInt(document.getElementById('biayaOperasiTagihan')?.value || 0),
            lainLain: parseInt(document.getElementById('biayaLainLain')?.value || 0),
            itemObat: itemObatArray,
        };
    }

    function savePembayaranData(id) {
        const index = dataRekamMedis.findIndex(r => r.id === id);
        if (index === -1) return;

        const newData = collectCurrentPembayaranData();
        dataRekamMedis[index].dataPembayaran = newData;

        saveData();
        alert("Detail Tagihan berhasil disimpan!");
        // Refresh tampilan dengan data baru (optional, karena input masih ada)
        renderPembayaranRekamMedis(id);
    }
    
    function markLunas(id) {
        if (confirm("Apakah Anda yakin ingin menandai tagihan ini sebagai LUNAS?")) {
            const index = dataRekamMedis.findIndex(r => r.id === id);
            if (index === -1) return;

            // Pastikan data tagihan terakhir disimpan sebelum lunas
            savePembayaranData(id);

            dataRekamMedis[index].statusPembayaran = "Lunas";
            saveData();
            
            alert("Pembayaran Lunas berhasil dicatat!");
            renderRekamMedis(); // Kembali ke daftar rekam medis untuk melihat status
        }
    }

    function handleHargaDasarSubmit(event) {
        event.preventDefault();
        const konsultasi = parseInt(document.getElementById('biayaKonsultasi').value);
        const rawatInap = parseInt(document.getElementById('biayaRawatInapPerMalam').value);
        const operasi = parseInt(document.getElementById('biayaOperasi').value);

        dataHargaDasar.biayaKonsultasi = konsultasi;
        dataHargaDasar.biayaRawatInapPerMalam = rawatInap;
        dataHargaDasar.biayaOperasi = operasi;
        
        saveData();
        alert("Harga Dasar berhasil disimpan!");
        renderPengaturanHarga(); 
    }

    function handleTambahObatSubmit(event) {
        event.preventDefault();
        const nama = document.getElementById('namaObat').value;
        const harga = parseInt(document.getElementById('hargaObat').value);
        
        if (isNaN(harga) || harga <= 0) return alert("Harga harus angka positif.");

        const newId = dataHargaDasar.obatDanLayanan.length > 0 
                      ? Math.max(...dataHargaDasar.obatDanLayanan.map(item => item.id)) + 1 
                      : 1;
        
        dataHargaDasar.obatDanLayanan.push({ id: newId, nama, harga });
        
        saveData();
        alert("Item berhasil ditambahkan!");
        renderPengaturanHarga(); 
    }

    function deleteObat(id) {
        if (confirm("Apakah Anda yakin ingin menghapus item ini dari daftar harga?")) {
            dataHargaDasar.obatDanLayanan = dataHargaDasar.obatDanLayanan.filter(item => item.id !== id);
            saveData();
            renderPengaturanHarga();
            alert("Item berhasil dihapus.");
        }
    }
    // END KODE BARU

    // --- Inisialisasi Navigasi ---
    const pageMap = {
        'dashboard': renderDashboard,
        'dokter': renderDokter,
        'pasien': renderPasien,
        'ruang': renderRuang,
        'rekam-medis': renderRekamMedis,
        'pembayaran': renderPembayaran, // BARU
        'laporan': renderLaporan
    };

    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const page = this.getAttribute('data-page');
            pageMap[page]();

            // TUTUP SIDEBAR PADA LAYAR KECIL SETELAH KLIK (PERBAIKAN Responsif)
            if (window.innerWidth <= 992) {
                document.querySelector('.sidebar').classList.remove('active');
                document.getElementById('sidebarOverlay').style.display = 'none';
            }
        });
    });
</script>
</body>
</html>